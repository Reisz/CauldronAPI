local args = {...}
local version, vstring = -1, "pre-alpha"
local thisProgram = shell.getRunningProgram()
local source, dir = string.sub(thisProgram, 1, #thisProgram - #string.match(thisProgram, "/[^/]+$") + 1)

local function install(name)
	if fs.exists(dir .. name) then fs.delete(dir .. name) end
	fs.copy(source .. name, dir .. name)
    write(".")
end

local function advancedInput(message, default)
    if type(default) ~= "string" then
        default = ""
    end

    local _, y = term.getCursorPos()
    term.clearLine()
    term.setCursorPos(1, y)
    term.write(message)
    
    local input = default
    while true do
        term.clearLine()
        term.setCursorPos(1, y)
        term.write(message)
        term.write(input)

        local e, p = os.pullEvent()
        if e == "char" then
            input = input .. p
        elseif e == "key" then
            if p == 14 then -- backspace
                input = string.sub(input, 1, #input - 1)
            elseif p == 28 then -- enter
                return input
            end
        end
    end
end

-- prepare terminal
term.setTextColor(colors.white)
term.setBackgroundColor(colors.black)

-- get install directory
shell.setDir("")

if args[1] then
    dir = shell.resolve(args[1])
end

if not dir then
    local input = advancedInput("Choose an install path > ", "CLibs")
    dir = shell.resolve(input)
    while input ~= dir or dir == "Cauldron" do
        write("\nInvalid Path!\n")
        input = advancedInput("Choose an install path > ", "CLibs")
        dir = shell.resolve(input)
    end
    write("\n")
end


write("Starting setup...\n\n")
fs.makeDir(dir)
if not string.find(dir, "/$") then dir = dir .. "/" end

write("Cauldron")
    local fileC = fs.open("Cauldron", "w")
    local fileM = fs.open(source .. "main", "r")

    if not fileC or not fileM then
        write('\nFailed to open the file "Cauldron", setup will be aborted.\n')
        return
    end
    
    fileC.write(string.format(fileM.readAll(), version, vstring, dir))
    fileC.close()
    fileM.close()
write(" ok\n")

write("Loader")
	install("middleclass")
write(" ok\n")

write("Modules")
    install("CCore")
write(" ok\n")

write("\nFinished installation...\n")
